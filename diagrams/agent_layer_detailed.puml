@startuml Agent_Layer_Detailed
!theme plain

title Agent Layer - Trading Strategies Architecture

' Base Interfaces
interface ITradingAgent {
    + analyze(market_data: List[MarketData]): TradingSignal
    + initialize(config: Dict): None
    + get_name(): str
    + get_description(): str
    + get_parameters(): Dict
}

interface IStrategy {
    + analyze(market_data: List[MarketData]): TradingSignal
    + get_parameters(): Dict
    + set_parameters(parameters: Dict): None
    + validate_signal(signal: TradingSignal): bool
}

' Base Agent
abstract class BaseAgent {
    # name: str
    # description: str
    # config: Dict[str, Any]
    # is_initialized: bool

    + initialize(config: Dict): None
    + get_name(): str
    + get_description(): str
    + get_parameters(): Dict
    # _validate_config(): None
    # _create_signal(symbol, action, confidence, ...): TradingSignal
    # _ensure_initialized(): None
    # _validate_market_data(data: List[MarketData]): None
    # _get_minimum_data_points(): int
    # _calculate_confidence(strength: float, volatility: float): float
    # _get_symbol_from_data(data: List[MarketData]): str
    # _create_neutral_signal(data: List[MarketData]): TradingSignal
    # _get_config_value(key: str, default: Any): Any
}

BaseAgent ..|> ITradingAgent

' Strategy Base Classes
abstract class TechnicalStrategy {
    # parameters: Dict[str, Any]
    # name: str
    # min_data_points: int
    # signal_threshold: float
    # stop_loss_pct: float
    # take_profit_pct: float

    + analyze(market_data: List[MarketData]): TradingSignal
    + get_parameters(): Dict
    + set_parameters(parameters: Dict): None
    + validate_signal(signal: TradingSignal): bool

    # {abstract} _calculate_indicators(df: DataFrame): DataFrame
    # {abstract} _generate_signal(df: DataFrame): Dict[str, Any]

    # _validate_signal_specific(signal: TradingSignal): bool
    # _market_data_to_dataframe(data: List[MarketData]): DataFrame
    # _create_signal(current_data: MarketData, signal_info: Dict): TradingSignal
    # _create_hold_signal(current_data: MarketData): TradingSignal

    # Technical Indicators
    # _calculate_sma(prices: Series, period: int): Series
    # _calculate_ema(prices: Series, period: int): Series
    # _calculate_rsi(prices: Series, period: int): Series
    # _calculate_macd(prices, fast, slow, signal): Tuple
    # _calculate_bollinger_bands(prices, period, std): Tuple
    # _calculate_stochastic(high, low, close, k, d): Tuple
    # _calculate_atr(high, low, close, period): Series

    # Utility Methods
    # _is_trend_bullish(prices: Series, period: int): bool
    # _is_trend_bearish(prices: Series, period: int): bool
    # _calculate_volatility(prices: Series, period: int): float
    # _normalize_strength(raw_value, min_val, max_val): float
}

TechnicalStrategy ..|> IStrategy

abstract class MLStrategy {
    # parameters: Dict[str, Any]
    # model: Any
    # scaler: StandardScaler
    # is_trained: bool
    # lookback_window: int
    # prediction_horizon: int
    # feature_columns: List[str]
    # target_column: str
    # test_size: float
    # validation_size: float
    # confidence_threshold: float
    # preprocessor: DataPreprocessor
    # last_training_time: datetime
    # training_score: float
    # validation_score: float

    + analyze(market_data: List[MarketData]): TradingSignal
    + get_parameters(): Dict
    + set_parameters(parameters: Dict): None
    + validate_signal(signal: TradingSignal): bool
    + train_model(training_data, retrain): Dict
    + save_model(filepath: str): None
    + load_model(filepath: str): None
    + needs_retraining(): bool
    + get_feature_importance(): Dict[str, float]
    + get_model_info(): Dict

    # {abstract} _create_model(): Any
    # {abstract} _train_model_impl(X_train, y_train, X_val, y_val): Dict
    # {abstract} _predict(features: ndarray): float
    # {abstract} _evaluate_model(X: ndarray, y: ndarray): float

    # _validate_signal_specific(signal: TradingSignal): bool
    # _prepare_features(market_data: List[MarketData]): ndarray
    # _prepare_training_features(market_data): DataFrame
    # _prepare_training_data(features_df: DataFrame): Tuple
    # _create_scaler(): Scaler
    # _prediction_to_signal(current_data, prediction, features): TradingSignal
    # _create_hold_signal(current_data: MarketData): TradingSignal
}

MLStrategy ..|> IStrategy

' Concrete Technical Strategies
class RSIStrategy {
    - period: int
    - overbought: int
    - oversold: int

    # _calculate_indicators(df: DataFrame): DataFrame
    # _generate_signal(df: DataFrame): Dict
}

class MACDStrategy {
    - fast_period: int
    - slow_period: int
    - signal_period: int

    # _calculate_indicators(df: DataFrame): DataFrame
    # _generate_signal(df: DataFrame): Dict
}

class MovingAverageStrategy {
    - short_period: int
    - long_period: int
    - ma_type: str

    # _calculate_indicators(df: DataFrame): DataFrame
    # _generate_signal(df: DataFrame): Dict
}

class BollingerBandsStrategy {
    - period: int
    - num_std: float

    # _calculate_indicators(df: DataFrame): DataFrame
    # _generate_signal(df: DataFrame): Dict
}

TechnicalStrategy <|-- RSIStrategy
TechnicalStrategy <|-- MACDStrategy
TechnicalStrategy <|-- MovingAverageStrategy
TechnicalStrategy <|-- BollingerBandsStrategy

' Concrete ML Strategies
class RandomForestStrategy {
    - n_estimators: int
    - max_depth: int
    - min_samples_split: int
    - model: RandomForestClassifier

    # _create_model(): RandomForestClassifier
    # _train_model_impl(X_train, y_train, X_val, y_val): Dict
    # _predict(features: ndarray): float
    # _evaluate_model(X: ndarray, y: ndarray): float
}

class LSTMStrategy {
    - hidden_size: int
    - num_layers: int
    - dropout: float
    - epochs: int
    - batch_size: int
    - model: Sequential

    # _create_model(): Sequential
    # _train_model_impl(X_train, y_train, X_val, y_val): Dict
    # _predict(features: ndarray): float
    # _evaluate_model(X: ndarray, y: ndarray): float
    - _reshape_for_lstm(X: ndarray): ndarray
}

MLStrategy <|-- RandomForestStrategy
MLStrategy <|-- LSTMStrategy

' Concrete Agents
class RSIAgent {
    - strategy: RSIStrategy

    + analyze(market_data: List[MarketData]): TradingSignal
}

class MACDAgent {
    - strategy: MACDStrategy

    + analyze(market_data: List[MarketData]): TradingSignal
}

class MovingAverageAgent {
    - strategy: MovingAverageStrategy

    + analyze(market_data: List[MarketData]): TradingSignal
}

class BollingerBandsAgent {
    - strategy: BollingerBandsStrategy

    + analyze(market_data: List[MarketData]): TradingSignal
}

class RandomForestAgent {
    - strategy: RandomForestStrategy

    + analyze(market_data: List[MarketData]): TradingSignal
    + train(): Dict
}

class LSTMAgent {
    - strategy: LSTMStrategy

    + analyze(market_data: List[MarketData]): TradingSignal
    + train(): Dict
}

BaseAgent <|-- RSIAgent
BaseAgent <|-- MACDAgent
BaseAgent <|-- MovingAverageAgent
BaseAgent <|-- BollingerBandsAgent
BaseAgent <|-- RandomForestAgent
BaseAgent <|-- LSTMAgent

RSIAgent --> RSIStrategy : delegates
MACDAgent --> MACDStrategy : delegates
MovingAverageAgent --> MovingAverageStrategy : delegates
BollingerBandsAgent --> BollingerBandsStrategy : delegates
RandomForestAgent --> RandomForestStrategy : delegates
LSTMAgent --> LSTMStrategy : delegates

' Agent Management
class AgentManager {
    - agents: Dict[str, ITradingAgent]
    - active_agent_name: str

    + register_agent(agent: ITradingAgent): None
    + get_agent(name: str): ITradingAgent
    + get_active_agent(): ITradingAgent
    + set_active_agent(name: str): bool
    + list_agents(): List[str]
    + remove_agent(name: str): None
}

AgentManager --> ITradingAgent : manages

class AgentFactory {
    - {static} _agent_types: Dict[str, Callable]

    + {static} register_agent_type(type: str, creator: Callable): None
    + {static} create_agent(type: str, config: Dict): ITradingAgent
    + {static} get_available_types(): List[str]
    + {static} is_type_registered(type: str): bool
}

AgentFactory ..> ITradingAgent : creates

class AgentBuilder {
    - agent_type: str
    - _config: Dict
    - _strategy: IStrategy
    - _exchange: IExchangeClient
    - _risk_manager: IRiskManager

    + with_config(config: Dict): AgentBuilder
    + with_strategy(strategy: IStrategy): AgentBuilder
    + with_exchange(exchange: IExchangeClient): AgentBuilder
    + with_risk_manager(risk_manager: IRiskManager): AgentBuilder
    + with_strategy_params(params: Dict): AgentBuilder
    + build(): ITradingAgent
}

AgentBuilder --> AgentFactory : uses
AgentBuilder ..> ITradingAgent : builds

' Support Classes
class DataPreprocessor {
    + create_features_for_ml(data: List[MarketData]): DataFrame
    + normalize_data(data: List[MarketData]): List[MarketData]
    + handle_missing_values(data: List[MarketData]): List[MarketData]
}

MLStrategy --> DataPreprocessor : uses

note top of TechnicalStrategy
    **Template Method Pattern**
    - analyze() defines workflow
    - Subclasses implement indicators
    - Reusable indicator library
    - Common signal creation
end note

note top of MLStrategy
    **Template Method Pattern**
    - analyze() and train() workflows
    - Subclasses implement model
    - Common feature preparation
    - Model persistence support
end note

note right of AgentFactory
    **Factory Pattern**
    - Register agent creators
    - Runtime type selection
    - Open/Closed Principle
    - Easy to extend
end note

note left of BaseAgent
    **Base Agent Responsibilities:**
    - Configuration management
    - Validation helpers
    - Signal creation utilities
    - Common agent lifecycle
end note

note bottom of AgentManager
    **Agent Manager Features:**
    - Multiple agent support
    - Active agent selection
    - Agent lifecycle
    - Centralized control
end note

@enduml
